<div id="home-top" class="home-top">
    <div class="govuk-width-container home-top__inner">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h1 class="govuk-heading-xl govuk-!-margin-top-5 govuk-!-margin-bottom-5">Manage users</h1>
            </div>
            <div class="govuk-grid-column-two-thirds">
                <h3 class="govuk-heading-m">
                    Here you'll find the users associated with your organisations, along with their details and permissions. 
                </h3>
            </div>
        </div>
    </div>
</div>

<div class="govuk-width-container">
    <% if (locals.flash.info) { %>
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="notification notification-success">
                    <%=locals.flash.info%>
                </div>
            </div>
        </div>
    <% } %>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <!--Search users-->
            <div class="govuk-form-group">
                <h2 class="govuk-heading-m govuk-!-margin-top-9 govuk-!-margin-bottom-0">
                    <label for="search-user">
                        Search users   
                    </label>
                </h2>
                <div id="search-user-hint" class="govuk-caption-l govuk-!-margin-top-0">
                    Search by user name
                </div>
                <form method="post">
                    <input type="hidden" name="_csrf" value="<%=csrfToken%>" />
                    <input type="hidden" name="page" value="1" />

                    <div class="govuk-grid-row">
                        <div class="govuk-grid-column-two-thirds">
                            <input class="govuk-input govuk-grid-column-two-thirds" 
                                id="search-user" 
                                name="search-user" 
                                type="text" 
                                aria-describedby="search-user-hint">
                        </div>
                        <button type="submit" class="govuk-button">Search</button>
                    </div>
                </form>
            </div>

            <!--Filter by Orgs-->
           <div class="govuk-!-margin-bottom-9 govuk-!-margin-top-4">
                <a class="govuk-link-bold govuk-!-font-size-19" href="#">
                    Filter by organisation
                </a>
           </div>
        </div>

        <div class="govuk-grid-column-one-third">
            <aside class="govuk-!-margin-top-9">
                <h2 class="govuk-heading-m">Related actions</h2>
                <ul class="govuk-list">
                    <li>
                        <a class="govuk-link-bold" href="<%=locals.inviteUserUrl%>">
                            Invite new user
                        </a>
                    </li>
                    <li>
                        <a class="govuk-link-bold" href="<%=locals.urls.help%>/manage-users">
                            Help with managing users
                        </a>
                    </li>
                    <li>
                        <a class="govuk-link-bold" href="<%=locals.urls.profile%>">
                            See my profile
                        </a>
                    </li>
                    <li>
                        <a class="govuk-link-bold" href="<%=locals.requestsUrl%>">
                            See requests
                        </a>
                    </li>
                </ul>
            </aside>
        </div>

    </div>

    <%
    const paginationModel = {
        method: 'post',
        csrfToken,
        currentPage: locals.page,
        numberOfPages: locals.numberOfPages,
        totalNumberOfResults: locals.totalNumberOfResults,
        numberOfResultsOnPage: locals.usersForOrganisation.users.length,
        data: [
            { key: 'criteria', value: locals.criteria },
            { key: 'sort', value: locals.sortBy },
            { key: 'sortDir', value: locals.sortOrder },
            { key: 'showFilters', value: locals.showFilters }
        ]
    }
    %>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <%- include('../../layouts/pagination', paginationModel); %>
            <table class="govuk-table">
                <thead class="govuk-table__head">
                <% let baseSortUri = `?page=${page}`;%>
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header width-30">
                        <!-- <a href="<%=baseSortUri%>&sort=searchableName&sortdir=<%= locals.sort.searchableName.nextDirection %>"
                            class="govuk-link-bold govuk-link--no-underline <% if (locals.sort.searchableName.applied) { %>sorted dir-<%= (locals.sort.searchableName.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                            Name
                        </a> -->
                        Name
                    </th>

                    <th scope="col" class="govuk-table__header width-50">
                        <table class="govuk-table govuk-!-margin-bottom-0">
                            <tr class="govuk-table__row">
                                <td class="govuk-body govuk-!-font-weight-bold govuk-!-padding-right-3">
                                    <!-- <a href="#" class="govuk-link-bold govuk-link--no-underline">
                                        Organisation
                                    </a> -->
                                    Organisation
                                </td>
                                <td class="govuk-body govuk-!-font-weight-bold govuk-!-width-one-quarter">
                                    <!-- <a href="#" class="govuk-link-bold govuk-link--no-underline">
                                        Permission
                                    </a> -->
                                    Permission
                                </td>
                            </tr>
                        </table>
                    </th>

                    <th scope="col" class="govuk-table__header width-10">
                        <!-- <a href="<%=baseSortUri%>&sort=statusId&sortdir=<%= locals.sort.statusId.nextDirection %>"
                            class="govuk-link-bold govuk-link--no-underline <% if (locals.sort.statusId.applied) { %>sorted dir-<%= (locals.sort.statusId.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                            Status
                        </a> -->
                        Status
                    </th>
                    <th scope="col" class="govuk-table__header width-10">
                        <!-- <a href="<%=baseSortUri%>&sort=lastLogin&sortdir=<%= locals.sort.lastLogin.nextDirection %>"
                            class="govuk-link-bold govuk-link--no-underline <% if (locals.sort.lastLogin.applied) { %>sorted dir-<%= (locals.sort.lastLogin.nextDirection === 'desc') ? 'd' : 'a' %> <% } %>">
                            Last login
                        </a> -->
                        Last login
                    </th>
                </tr>
                </thead>
                
                <tbody class="govuk-table__body">
                
                <% if(locals.usersForOrganisation.users.length === 0) { %>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell" colspan="5"><span class="empty-state">No users found</span></td>
                    </tr>
                <% } %>
                
                <% for(let i= 0; i < locals.usersForOrganisation.users.length; i++) {
                const user = locals.usersForOrganisation.users[i]%>
                
                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__cell">
                        <p class="service-link">
                            <a class="govuk-link-bold" href="/approvals/users/<%= user.id%>">
                                <%= user.firstName %> <%= user.lastName %>
                            </a>
                        </p>
                    </th>

                    <% if (user.organisations.length > 0) { %>
                        <td class="govuk-table__cell govuk-body govuk-!-font-size-16" > 
                            <table class="govuk-table govuk-!-margin-bottom-0">
                                <% for(let j= 0; j < user.organisations.length; j++) { %>
                                    <tr class="govuk-table__row">
                                        <!-- <td class="govuk-table__cell govuk-body govuk-!-font-size-16 govuk-!-font-weight-bold"> -->
                                        <td class="govuk-body govuk-!-font-size-16 govuk-!-font-weight-bold govuk-!-padding-right-3">
                                            <% const orgName = user.organisations[j].name %>
                                            <%= orgName %>
                                        </td>
                                        <!-- <td class="govuk-table__cell govuk-body govuk-!-font-size-16 govuk-!-width-one-quarter"> -->
                                        <td class="govuk-body govuk-!-font-size-16 govuk-!-width-one-quarter">
                                            <% const permissionName = user.organisations[j].roleId === 10000 ? 'Approver' : 'End user'; %>
                                            <%= permissionName %>
                                        </td>
                                    </tr>
                                <% } %>
                            </table>
                        </td>
                    <% } else { %>
                        <td class="govuk-table__cell govuk-body govuk-!-font-size-16">
                            Unknown
                        </td>
                    <% } %>

                    <td class="govuk-table__cell govuk-body govuk-!-font-size-16">
                        <%= user.statusId.description %>
                    </td>

                    <td class="govuk-table__cell govuk-body govuk-!-font-size-16">
                        <%=user.lastLogin ? locals.moment(user.lastLogin).format('DD/MM/YYYY hh:mm A') : 'Never'%>
                    </td>
                </tr>
                <% } %>
                </tbody>
            </table>
            <%- include('../../layouts/pagination', paginationModel); %>
        </div>
    </div>
</div>
